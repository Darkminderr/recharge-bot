import os, asyncio, logging
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes
from playwright.async_api import async_playwright
from flask import Flask
from threading import Thread

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

app = Flask('')
@app.route('/')
def home(): return "UPI Request Bot is Running!"

def run_flask():
    port = int(os.environ.get("PORT", 8080))
    app.run(host='0.0.0.0', port=port)

TOKEN = '7510297537:AAEeCr_pl4CndrNCpBpr7Ac8mL3jlFKpyRk'
URL = "https://superprofile.bio/vp/6994a964b7a14d00133409f7"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("‡¥π‡¥≤‡µã! ‡¥±‡µÄ‡¥ö‡¥æ‡µº‡¥ú‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥Ø‡µÅ‡¥™‡¥ø‡¥ê ‡¥ê‡¥°‡¥ø ‡¥Ö‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥´‡µã‡µ∫ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µç ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï.\n‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥Ç: /recharge 9876543210")

async def process_payment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # ‡¥Ø‡µÇ‡¥∏‡µº ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥§‡¥®‡µç‡¥®‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã ‡¥é‡¥®‡µç‡¥®‡µç ‡¥®‡µã‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    if not context.args:
        await update.message.reply_text("‚ö†Ô∏è ‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ UPI ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥ï‡µÇ‡¥ü‡¥ø ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï.\n‡¥â‡¥¶‡¥æ‡¥π‡¥∞‡¥£‡¥Ç: /recharge 9876543210")
        return
        
    user_upi_id = context.args[0]
    msg = await update.message.reply_text("‚è≥ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥Ø‡µç‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç ‡¥±‡¥ø‡¥ï‡µç‡¥µ‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥§‡¥Ø‡µç‡¥Ø‡¥æ‡¥±‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ...")
    
    async with async_playwright() as p:
        try:
            browser = await p.chromium.launch(args=['--no-sandbox', '--disable-dev-shm-usage'])
            # ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥µ‡µÄ‡¥°‡¥ø‡¥Ø‡µã‡¥Ø‡¥ø‡¥≤‡µÜ ‡¥™‡µã‡¥≤‡µÜ ‡¥°‡µÜ‡¥∏‡µç‡¥ï‡µç‡¥ü‡µã‡¥™‡µç‡¥™‡µç ‡¥µ‡µç‡¥Ø‡µÇ ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
            browser_context = await browser.new_context(viewport={'width': 1366, 'height': 768})
            page = await browser_context.new_page()
            
            await page.goto(URL, wait_until="networkidle", timeout=60000)
            
            # 1. ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ ‡¥ï‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
            btn_locator = page.locator('button:has-text("Get it now")')
            await btn_locator.first.wait_for(state="visible", timeout=15000)
            await btn_locator.first.click(force=True) 
            
            await asyncio.sleep(2)
            
            # 2. ‡¥á‡¥Æ‡µÜ‡¥Ø‡¥ø‡¥≤‡µÅ‡¥Ç ‡¥´‡µã‡¥£‡µÅ‡¥Ç ‡¥ì‡¥ü‡µç‡¥ü‡µã‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
            email_field = page.locator('input[placeholder*="Email"]').first
            await email_field.fill("sanjuchacko628@gmail.com")
            
            phone_field = page.locator('input[type="tel"]').first
            await phone_field.fill("9188897019")
            
            # 3. ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç Get it now ‡¥ï‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
            await btn_locator.last.click(force=True)
            
            await msg.edit_text("‚è≥ UPI ‡¥ó‡µá‡¥±‡µç‡¥±‡µç‚Äå‡¥µ‡µá‡¥Ø‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥ï‡¥£‡¥ï‡µç‡¥ü‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...")
            await asyncio.sleep(8) # ‡¥™‡µÜ‡¥Ø‡µç‚Äå‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç ‡¥¨‡µã‡¥ï‡µç‡¥∏‡µç ‡¥≤‡µã‡¥°‡µç ‡¥Ü‡¥ï‡¥æ‡µª
            
            # 4. UPI ‡¥ì‡¥™‡µç‡¥∑‡µª ‡¥ï‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ (‡¥µ‡µÄ‡¥°‡¥ø‡¥Ø‡µã‡¥Ø‡¥ø‡µΩ ‡¥ï‡¥£‡µç‡¥ü‡¥§‡µÅ‡¥™‡µã‡¥≤‡µÜ)
            await page.locator('text="UPI"').last.click()
            await asyncio.sleep(2)
            
            # 5. ‡¥Ø‡µÇ‡¥∏‡µº ‡¥§‡¥®‡µç‡¥® ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
            upi_input = page.locator('input[placeholder*="Mobile No."]')
            await upi_input.fill(user_upi_id)
            
            # 6. Proceed ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ ‡¥ï‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
            await page.locator('button:has-text("Proceed")').click()
            
            # ‡¥±‡¥ø‡¥ï‡µç‡¥µ‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö ‡¥µ‡¥ø‡¥µ‡¥∞‡¥Ç ‡¥Ø‡µÇ‡¥∏‡¥±‡µÜ ‡¥Ö‡¥±‡¥ø‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
            await msg.edit_text(f"‚úÖ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥Ü‡¥™‡µç‡¥™‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ( {user_upi_id} ) ‡¥™‡µÜ‡¥Ø‡µç‚Äå‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç ‡¥±‡¥ø‡¥ï‡µç‡¥µ‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µç!\n\n‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥Ü‡¥™‡µç‡¥™‡µç ‡¥§‡µÅ‡¥±‡¥®‡µç‡¥®‡µç ‡¥á‡¥™‡µç‡¥™‡µã‡µæ ‡¥§‡¥®‡µç‡¥®‡µÜ ‡¥™‡µÜ‡¥Ø‡µç‚Äå‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç ‡¥™‡µÇ‡µº‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï. (‡¥∏‡¥Æ‡¥Ø‡¥Ç: 5 ‡¥Æ‡¥ø‡¥®‡¥ø‡¥±‡µç‡¥±‡µç)")
            
            # 7. ‡¥™‡µÜ‡¥Ø‡µç‚Äå‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç ‡¥∏‡¥ï‡µç‡¥∏‡¥∏‡µç ‡¥Ü‡¥ï‡¥æ‡µª ‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ (‡¥™‡¥∞‡¥Æ‡¥æ‡¥µ‡¥ß‡¥ø 5 ‡¥Æ‡¥ø‡¥®‡¥ø‡¥±‡µç‡¥±‡µç)
            try:
                # ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µÄ‡¥®‡¥ø‡µΩ "Payment Successful" ‡¥µ‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã ‡¥é‡¥®‡µç‡¥®‡µç ‡¥®‡µã‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
                await page.wait_for_selector('text="Payment Successful"', timeout=300000) 
                
                # ‡¥∏‡¥ï‡µç‡¥∏‡¥∏‡µç ‡¥Ü‡¥Ø‡¥æ‡µΩ ‡¥Ø‡µÇ‡¥∏‡µº‡¥ï‡µç‡¥ï‡µç ‡¥Æ‡µÜ‡¥∏‡µç‡¥∏‡µá‡¥ú‡µç!
                await update.message.reply_text("üéâ ‡¥™‡µÜ‡¥Ø‡µç‚Äå‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ï‡¥∞‡¥Ç! ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ó‡µÜ‡¥Ø‡¥ø‡¥Æ‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥±‡µÄ‡¥ö‡¥æ‡µº‡¥ú‡µç ‡¥§‡µÅ‡¥ï ‡¥Ü‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µç.")
                
                # -----------------------------------------------------------------
                # ‡¥∏‡¥û‡µç‡¥ú‡µÅ, ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ‡¥Ø‡¥æ‡¥£‡µç ‡¥ó‡µÜ‡¥Ø‡¥ø‡¥Æ‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥ï‡µç‡¥Ø‡¥æ‡¥∑‡µç ‡¥Ü‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥ï‡µã‡¥°‡µç ‡¥®‡¥Æ‡µç‡¥Æ‡µæ ‡¥é‡¥¥‡µÅ‡¥§‡µá‡¥£‡µç‡¥ü‡¥§‡µç!
                # -----------------------------------------------------------------
                
            except Exception as wait_err:
                await update.message.reply_text("‚è∞ ‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û‡µÅ! ‡¥™‡µÜ‡¥Ø‡µç‚Äå‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤. ‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥∂‡µç‡¥∞‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.")
            
        except Exception as e:
            await update.message.reply_text(f"‚ùå ‡¥í‡¥∞‡µÅ ‡¥§‡¥ü‡¥∏‡µç‡¥∏‡¥Ç ‡¥®‡µá‡¥∞‡¥ø‡¥ü‡µç‡¥ü‡µÅ: {str(e)}")
            await page.screenshot(path="error.png")
            await update.message.reply_photo(photo=open("error.png", 'rb'))
        finally:
            await browser.close()

if __name__ == '__main__':
    Thread(target=run_flask).start()
    application = ApplicationBuilder().token(TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("recharge", process_payment))
    print("UPI Request Bot is Starting...")
    application.run_polling()
